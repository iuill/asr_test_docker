services:
  # =============================================================================
  # reazonspeech-k2-v2 (sherpa-onnx based)
  # =============================================================================

  # GPU version (default)
  k2-v2:
    build:
      context: ./services/k2-v2
      dockerfile: Dockerfile
    ports:
      - "13780:8000"
    volumes:
      - k2-v2-model-cache:/root/.cache/huggingface
    environment:
      - HF_HOME=/root/.cache/huggingface
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
    restart: unless-stopped

  # CPU version (alternative)
  k2-v2-cpu:
    build:
      context: ./services/k2-v2
      dockerfile: Dockerfile.cpu
    ports:
      - "13780:8000"
    volumes:
      - k2-v2-model-cache:/root/.cache/huggingface
    environment:
      - HF_HOME=/root/.cache/huggingface
    profiles:
      - cpu
    restart: unless-stopped

  # =============================================================================
  # reazonspeech-espnet-v2 (ESPnet based)
  # =============================================================================

  # GPU version
  espnet-v2:
    build:
      context: ./services/espnet-v2
      dockerfile: Dockerfile
    ports:
      - "13781:8000"
    volumes:
      - espnet-v2-model-cache:/root/.cache/huggingface
      - espnet-v2-torch-cache:/root/.cache/torch
    environment:
      - HF_HOME=/root/.cache/huggingface
      - TORCH_HOME=/root/.cache/torch
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
    restart: unless-stopped

  # CPU version (alternative)
  espnet-v2-cpu:
    build:
      context: ./services/espnet-v2
      dockerfile: Dockerfile.cpu
    ports:
      - "13781:8000"
    volumes:
      - espnet-v2-model-cache:/root/.cache/huggingface
      - espnet-v2-torch-cache:/root/.cache/torch
    environment:
      - HF_HOME=/root/.cache/huggingface
      - TORCH_HOME=/root/.cache/torch
    profiles:
      - cpu
    restart: unless-stopped

  # =============================================================================
  # reazonspeech-espnet-v2-onnx (ESPnet ONNX based - High Performance)
  # =============================================================================

  # GPU version
  espnet-v2-onnx:
    build:
      context: ./services/espnet-v2-onnx
      dockerfile: Dockerfile
    ports:
      - "13782:8000"
    volumes:
      - espnet-v2-onnx-model-cache:/root/.cache/huggingface
      - ./cache/espnet_onnx:/root/.cache/espnet_onnx
      - espnet-v2-onnx-torch-cache:/root/.cache/torch
    environment:
      - HF_HOME=/root/.cache/huggingface
      - ESPNET_ONNX_CACHE=/root/.cache/espnet_onnx
      - TORCH_HOME=/root/.cache/torch
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
    restart: unless-stopped

  # CPU version (alternative)
  espnet-v2-onnx-cpu:
    build:
      context: ./services/espnet-v2-onnx
      dockerfile: Dockerfile.cpu
    ports:
      - "13782:8000"
    volumes:
      - espnet-v2-onnx-model-cache:/root/.cache/huggingface
      - ./cache/espnet_onnx:/root/.cache/espnet_onnx
      - espnet-v2-onnx-torch-cache:/root/.cache/torch
    environment:
      - HF_HOME=/root/.cache/huggingface
      - ESPNET_ONNX_CACHE=/root/.cache/espnet_onnx
      - TORCH_HOME=/root/.cache/torch
    profiles:
      - cpu
    restart: unless-stopped

volumes:
  k2-v2-model-cache:
  espnet-v2-model-cache:
  espnet-v2-torch-cache:
  espnet-v2-onnx-model-cache:
  espnet-v2-onnx-torch-cache:
